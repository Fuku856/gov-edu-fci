rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 許可されたメールアドレスが許可されているかチェック
    function isAllowedEmail(email) {
      return email != null && (
        email.lower().split('@')[1] == 'fcihs-satoyama.ed.jp' ||
        email.lower().split('@')[1] == 'fcidux.dpdns.org'
      );
    }
    
    // 許可されたユーザーかチェック（Firestoreのallowed_usersコレクションから）
    function isAllowedUser() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/allowed_users/$(request.auth.uid));
    }
    
    // 管理者かチェック
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // 認証済みかつ許可されたユーザーかチェック
    function isAuthenticatedAndAllowed() {
      return request.auth != null && 
             (isAllowedEmail(request.auth.token.email) || isAllowedUser());
    }

    // 許可されたユーザーのリスト
    // 読み取り: メールドメインが許可されているユーザー、または管理者、または自分自身のレコード
    // 書き込み: 管理者、または自分自身のレコードを追加（GitHub認証でログインしたユーザーが自動登録するため）
    match /allowed_users/{userId} {
      allow read: if request.auth != null && 
                    (isAllowedEmail(request.auth.token.email) || 
                     isAdmin() || 
                     request.auth.uid == userId);
      // 書き込み: 管理者、または自分自身のレコードを追加（初回のみ）
      allow create: if request.auth != null && 
                      (isAdmin() || 
                       (request.auth.uid == userId && 
                        request.resource.data.userId == userId &&
                        !exists(/databases/$(database)/documents/allowed_users/$(userId))));
      // 更新・削除: 管理者のみ
      allow update, delete: if isAdmin();
    }

    match /admins/{adminId} {
      allow read: if request.auth != null &&
                    (request.auth.uid == adminId ||
                     isAdmin());

      allow write: if request.auth != null &&
                     isAdmin() &&
                     get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin';
    }

    match /posts/{postId} {
      allow read: if isAuthenticatedAndAllowed() &&
                    resource.data.status == 'approved';

      allow read: if isAuthenticatedAndAllowed() &&
                    (resource.data.status == 'pending' || resource.data.status == 'rejected') &&
                    isAdmin();

      allow read: if isAuthenticatedAndAllowed() &&
                    resource.data.authorId == request.auth.uid;

      allow create: if isAuthenticatedAndAllowed() &&
                      request.resource.data.authorId == request.auth.uid &&
                      request.resource.data.status == 'pending';

      allow update: if isAuthenticatedAndAllowed() &&
                      isAdmin() &&
                      (request.resource.data.status == 'approved' || request.resource.data.status == 'rejected');

      allow delete: if isAuthenticatedAndAllowed() &&
                      (resource.data.authorId == request.auth.uid || isAdmin());

      match /votes/{voteUserId} {
        allow read: if isAuthenticatedAndAllowed();

        allow create: if isAuthenticatedAndAllowed() &&
                        request.auth.uid == voteUserId &&
                        request.resource.data.postId == postId &&
                        (request.resource.data.voteType == 'agree' ||
                         request.resource.data.voteType == 'neutral' ||
                         request.resource.data.voteType == 'disagree') &&
                        !exists(/databases/$(database)/documents/posts/$(postId)/votes/$(voteUserId));

        allow delete: if isAuthenticatedAndAllowed() && request.auth.uid == voteUserId;
      }
    }

    match /daily_counters/{date} {
      allow read: if isAuthenticatedAndAllowed();
      allow write: if isAuthenticatedAndAllowed();
    }
  }
}
