rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 許可されたメールアドレスが許可されているかチェック
    function isAllowedEmail(email) {
      return email != null && (
        email.lower().split('@')[1] == 'fcihs-satoyama.ed.jp' ||
        email.lower().split('@')[1] == 'fcidux.dpdns.org'
      );
    }
    
    // 許可されたユーザーかチェック（Firestoreのallowed_usersコレクションから）
    function isAllowedUser() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/allowed_users/$(request.auth.uid));
    }
    
    // 管理者かチェック
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // 認証済みかつ許可されたユーザーかチェック
    // トランザクション内でも確実に動作するように、メールドメインチェックを優先
    function isAuthenticatedAndAllowed() {
      return request.auth != null && (
        (request.auth.token.email != null && isAllowedEmail(request.auth.token.email)) ||
        isAllowedUser()
      );
    }

    // 許可されたユーザーのリスト
    // 読み取り: 認証済みユーザーは自分自身のレコードを読み取れる、管理者はすべて読み取れる
    // また、isAllowedUser()関数内でexists()を評価するために、認証済みユーザーは読み取り可能
    // 書き込み: 管理者、または自分自身のレコードを追加（GitHub認証でログインしたユーザーが自動登録するため）
    match /allowed_users/{userId} {
      allow read: if request.auth != null;
      // 書き込み: 管理者、または自分自身のレコードを追加（初回のみ）
      allow create: if request.auth != null && 
                      (isAdmin() || 
                       (request.auth.uid == userId && 
                        request.resource.data.userId == userId &&
                        !exists(/databases/$(database)/documents/allowed_users/$(userId))));
      // 更新・削除: 管理者のみ
      allow update, delete: if isAdmin();
    }

    match /admins/{adminId} {
      allow read: if request.auth != null &&
                    (request.auth.uid == adminId ||
                     isAdmin());

      allow write: if request.auth != null &&
                     isAdmin() &&
                     get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin';
    }

    match /posts/{postId} {
      allow read: if isAuthenticatedAndAllowed() &&
                    resource.data.status == 'approved';

      allow read: if isAuthenticatedAndAllowed() &&
                    (resource.data.status == 'pending' || resource.data.status == 'rejected') &&
                    isAdmin();

      allow read: if isAuthenticatedAndAllowed() &&
                    resource.data.authorId == request.auth.uid;

      allow create: if isAuthenticatedAndAllowed() &&
                      request.resource.data.authorId == request.auth.uid &&
                      request.resource.data.status == 'pending';

      // 管理者のみがstatusを更新できる
      allow update: if isAuthenticatedAndAllowed() &&
                      isAdmin() &&
                      (request.resource.data.status == 'approved' || request.resource.data.status == 'rejected');
      
      // 一般ユーザーは投票カウントのみ更新できる（投票時に自動更新される）
      // transaction.set()でmerge: trueを使用している場合、request.resource.dataには指定したフィールドのみが含まれる
      // したがって、存在するフィールドのみをチェックする
      allow update: if isAuthenticatedAndAllowed() &&
                      // statusフィールドが変更されていない、または存在しない（merge: trueの場合）
                      (!('status' in request.resource.data) || request.resource.data.status == resource.data.status) &&
                      // 他の重要なフィールドが変更されていない、または存在しない（merge: trueの場合）
                      (!('authorId' in request.resource.data) || request.resource.data.authorId == resource.data.authorId) &&
                      (!('title' in request.resource.data) || request.resource.data.title == resource.data.title) &&
                      (!('content' in request.resource.data) || request.resource.data.content == resource.data.content) &&
                      (!('authorName' in request.resource.data) || request.resource.data.authorName == resource.data.authorName) &&
                      (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt);

      allow delete: if isAuthenticatedAndAllowed() &&
                      (resource.data.authorId == request.auth.uid || isAdmin());

      match /votes/{voteUserId} {
        allow read: if isAuthenticatedAndAllowed();

        allow create: if isAuthenticatedAndAllowed() &&
                        request.auth.uid == voteUserId &&
                        request.resource.data.postId == postId &&
                        (request.resource.data.voteType == 'agree' ||
                         request.resource.data.voteType == 'neutral' ||
                         request.resource.data.voteType == 'disagree') &&
                        !exists(/databases/$(database)/documents/posts/$(postId)/votes/$(voteUserId));

        allow delete: if isAuthenticatedAndAllowed() && request.auth.uid == voteUserId;
      }
    }

    match /daily_counters/{date} {
      allow read: if isAuthenticatedAndAllowed();
      allow write: if isAuthenticatedAndAllowed();
    }

    // ログイン履歴
    // 読み取り: 管理者のみ
    // 書き込み: 認証済みユーザー（自分自身のログイン履歴を保存）
    match /login_history/{historyId} {
      allow read: if isAdmin();
      allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
  }
}
