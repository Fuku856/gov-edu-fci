# トラブルシューティング: リダイレクトループ

## 🔴 問題: サイトに接続できない（リダイレクトループ）

### 症状
- サイトにアクセスすると「ページの自動転送設定が正しくありません」というエラーが表示される
- 「サーバーの自動転送設定がループしています」というメッセージが表示される

### 原因
サーバー側（`functions/_middleware.js`）の認証チェックとクライアント側（`auth.js`）の認証チェックが競合して、リダイレクトループが発生していました。

### 解決方法
サーバー側の認証チェックを無効化し、クライアント側の認証のみを使用するように修正しました。

## ✅ 修正内容

### `functions/_middleware.js` を簡略化
- サーバー側の認証チェックを無効化
- すべてのリクエストを許可
- 認証チェックはクライアント側（`auth.js`）で行う

## 🔄 次のステップ

1. **変更をコミット＆プッシュ**
   ```bash
   git add functions/_middleware.js
   git commit -m "リダイレクトループを修正: サーバー側認証を無効化"
   git push
   ```

2. **デプロイを確認**
   - Cloudflare Pagesでデプロイが完了するまで数分待つ

3. **サイトにアクセス**
   - ブラウザをシークレットモードで開く
   - サイトのURLにアクセス
   - ログインページが表示されることを確認

4. **ログインをテスト**
   - 「Googleでログイン」をクリック
   - 学校のGoogleアカウントでログイン
   - サイトが表示されることを確認

## 📝 現在の認証方式

### クライアント側認証（現在使用中）
- **認証チェック**: ブラウザ側（`auth.js`）で実行
- **メリット**: 
  - 実装が簡単
  - リダイレクトループが発生しない
  - ユーザー体験が良い
- **デメリット**:
  - セキュリティレベルがやや低い（技術的に詳しい人はソースコードを確認できる）
  - クライアント側で認証をバイパスできる可能性がある

### サーバー側認証（将来的に実装可能）
- **認証チェック**: サーバー側（`functions/_middleware.js`）で実行
- **メリット**:
  - セキュリティレベルが高い
  - クライアント側で認証をバイパスできない
- **デメリット**:
  - 実装が複雑
  - Firebase IDトークンの検証が必要
  - リダイレクトループに注意が必要

## 🔒 セキュリティについて

### 現在の実装
クライアント側認証を使用しているため、技術的に詳しい人は以下が可能です：
- ブラウザの開発者ツールで認証チェックをバイパス
- ソースコードを確認して認証ロジックを理解

### より高いセキュリティが必要な場合
サーバー側認証を実装することを検討してください。ただし、以下が必要です：
- Firebase IDトークンの検証（Googleの公開鍵を使用）
- リダイレクトループの防止
- クッキーまたはヘッダーでトークンを送信

## ❓ よくある質問

### Q: クライアント側認証で本当に大丈夫ですか？
A: 生徒会サイトのような用途であれば、クライアント側認証で十分です。機密情報を扱う場合は、サーバー側認証の実装を検討してください。

### Q: サーバー側認証はいつ実装できますか？
A: 必要に応じて実装できます。ただし、Firebase IDトークンの検証を正しく実装する必要があります。

### Q: 環境変数はまだ必要ですか？
A: 現在はクライアント側認証のみを使用しているため、Cloudflare環境変数（`FIREBASE_PROJECT_ID`、`ALLOWED_EMAIL_DOMAINS`）は不要です。将来的にサーバー側認証を実装する場合は必要になります。

---

問題が解決しない場合は、ブラウザのコンソール（F12キー）でエラーメッセージを確認してください。

